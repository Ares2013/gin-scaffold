package config

import (
	"gopkg.in/mgo.v2"
	//"gopkg.in/mgo.v2/bson"
	"log"
	"os"
)

var mongodbSession *mgo.Session
var (
	dbPrefix = "{{.DatabaseNamePrefix}}"
)

func DBSession() *mgo.Session {
	if mongodbSession != nil {
		return mongodbSession
	}

	uri := os.Getenv("MONGODB_URI")
	if uri == "" {
		uri = "mongodb://localhost"
	}

	var err error
	mongodbSession, err = mgo.Dial(uri)
	if mongodbSession == nil || err != nil {
		log.Fatalf("Can't connect to mongo, go error %v\n", err)
	}

	mongodbSession.SetSafe(&mgo.Safe{})
	return mongodbSession
}

func DB(name string) *mgo.Database {
	return DBSession().DB(name)
}

func DefaultDB() *mgo.Database {
	switch Environment {
	case "test":
		{
			return DB(dbPrefix + "-test")
		}

	case "production":
		{
			return DB(dbPrefix + "-production")
		}
	}

	return DB(dbPrefix + "-development")
}

// vi:syntax=go
